# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Godig is a minimal L7 tunneling service that exposes local HTTP services publicly through subdomain-based routing. The project follows a strict "no scope creep" philosophy - conceived for developers, designed for production.

## Build and Development Commands

```bash
# Build the tunnel server
go build -o godig-server ./cmd/server

# Build the tunnel client/service
go build -o godig-service ./cmd/service

# Run tests
go test ./...

# Run a specific test
go test ./pkg/auth -run TestGenerateToken
```

## Running the Components

**Server** (accepts tunnel connections and routes HTTP traffic):
```bash
GODIG_API_KEY=<shared-secret> GODIG_HOST=godig.xyz ./godig-server
# Listens on :8080 for tunnel connections
# Listens on :8081 for HTTP traffic
```

**Client/Service** (exposes local service):
```bash
GODIG_API_KEY=<shared-secret> ./godig-service -server godig.xyz:8080 -local localhost:3000
# Optional: -persist-config to save tunnel ID and bearer token to godig-tunnel.yaml
# Optional: -generate-qr to display QR code with tunnel URL and auth
```

## Architecture

Three components communicate in a specific flow:

1. **Client/Service** (`cmd/service/main.go`): Connects to the server, exposes local HTTP service
2. **Server** (`cmd/server/main.go`): Routes public HTTP requests to the appropriate tunnel
3. **End User**: Accesses the service via `https://{tunnel-id}.godig.xyz`

### Authentication Flow

- **Server ↔ Service**: Pre-shared API key via `GODIG_API_KEY` environment variable
- **Client ↔ Server**: Bearer token generated by service on first connection
- Tunnel ID is a randomly generated 5-character lowercase string
- Bearer token is a randomly generated 20-character base32 string

### Connection Architecture

Uses **yamux** (github.com/hashicorp/yamux) for stream multiplexing over a single TCP connection:

1. Service establishes TCP connection to server on port 8080
2. Handshake exchange (JSON): `HandshakeMessage` with TunnelID, APIKey, Bearer
3. Yamux session created over the TCP connection
4. For each HTTP request to `{tunnel-id}.godig.xyz:8081`:
   - Server validates bearer token from Authorization header
   - Server opens new yamux stream
   - HTTP request forwarded through stream to service
   - Service proxies to local service (e.g., localhost:3000)
   - Response streamed back through same multiplexed connection

### Key Implementation Details

**Streaming Support** (`cmd/server/streaming.go`):
- SSE (Server-Sent Events) and chunked responses are handled specially
- Keep-alive comments sent every 25 seconds to prevent connection timeouts
- Stream deadlines extended by 60 seconds on each keep-alive

**Config Persistence** (`pkg/tunnel/config.go`):
- When `-persist-config` is used, tunnel ID and bearer token saved to `godig-tunnel.yaml`
- Allows service to maintain same subdomain across restarts
- Config loaded automatically on subsequent runs

**Reconnection Logic** (`pkg/tunnel/tunnel.go`):
- Service automatically reconnects if connection lost
- 5-second retry delay with context cancellation support
- No exponential backoff (TODO in code)

## Package Structure

- `cmd/server/main.go`: Tunnel server - accepts service connections, routes HTTP requests
- `cmd/service/main.go`: Tunnel client - connects to server, exposes local service
- `pkg/tunnel/`: Core tunneling logic (client connection, stream handling, config persistence)
- `pkg/auth/`: Authentication utilities (API key retrieval, token generation)
- `pkg/headers/`: HTTP header manipulation for proxying
- `types/`: Shared type definitions (HandshakeMessage, TunnelConfig)

## Important Behaviors

**Subdomain Extraction**: Server extracts tunnel ID from first subdomain of Host header (cmd/server/main.go:144-159)

**Session Replacement**: If a service reconnects with same tunnel ID, existing session is closed and replaced (cmd/server/main.go:238-244)

**Deadline Management**:
- Initial handshake: 30-second timeout
- Request reading: 30-second timeout
- Long-running connections: Deadline cleared after initial read
- Streaming: 60-second deadline, renewed on keep-alive

**Proxy Headers**: Hop-by-hop headers removed, X-Forwarded-For and related proxy headers added (pkg/headers/)

# Coding guidelines

## Comments

All comments should end in periods.
